@model List<PetClinicSystem.Models.Owner>

@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = "Owners";

    int role = Context.Session.GetInt32("UserRole") ?? -1;
    bool canManageOwners = (role == 1 || role == 2); // Admin / Staff

    // Layout per role
    if (role == 1)
    {
        Layout = "~/Views/Shared/_Layout_Admin.cshtml";
    }
    else if (role == 2)
    {
        Layout = "~/Views/Shared/_Layout_Staff.cshtml";
    }
    else if (role == 0)
    {
        Layout = "~/Views/Shared/_Layout_Client.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_Layout_Public.cshtml";
    }

    ViewBag.ActiveMenu = "Owners";
    var searchValue = ViewBag.Search as string ?? "";
}

<div class="container py-4">

    <!-- HEADER + ACTIONS -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold mb-0">Owners</h3>

        <div class="d-flex gap-2">
            <input id="searchBox"
                   type="text"
                   class="form-control"
                   style="max-width: 260px;"
                   placeholder="Search owners..."
                   value="@searchValue" />

            <button class="btn btn-outline-secondary" type="button" onclick="applyOwnerSearch()">
                <i class="fa-solid fa-filter"></i> Filter
            </button>

            @if (canManageOwners)
            {
                <button class="btn btn-success"
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#ownerCreateModal"
                        onclick="loadOwnerCreate()">
                    <i class="fa-solid fa-plus"></i> New Owner
                </button>
            }
        </div>
    </div>

    <!-- GRID OF OWNER CARDS -->
    <div class="row g-3" id="ownersContainer">
        @await Html.PartialAsync("_OwnerCards", Model)
    </div>
</div>

<!-- MODAL SHELLS -->
<div class="modal fade" id="ownerCreateModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="ownerCreateContent"></div>
    </div>
</div>

<div class="modal fade" id="ownerViewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="ownerViewContent"></div>
    </div>
</div>

<div class="modal fade" id="ownerEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="ownerEditContent"></div>
    </div>
</div>

<div class="modal fade" id="ownerDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="ownerDeleteContent"></div>
    </div>
</div>

@section Scripts {
    <script>
        // SEARCH – reload with ?search=
        function applyOwnerSearch() {
            var q = document.getElementById("searchBox").value || "";
            var url = "/Owners/Index";
            if (q.trim() !== "") {
                url += "?search=" + encodeURIComponent(q.trim());
            }
            window.location.href = url;
        }

        document.addEventListener("DOMContentLoaded", function () {
            var sb = document.getElementById("searchBox");
            if (sb) {
                sb.addEventListener("keyup", function (e) {
                    if (e.key === "Enter") {
                        applyOwnerSearch();
                    }
                });
            }
        });

        // CREATE
        function loadOwnerCreate() {
            $("#ownerCreateContent").html("Loading...");
            $("#ownerCreateContent").load("/Owners/CreateOwner", function () {
                new bootstrap.Modal(document.getElementById("ownerCreateModal")).show();
            });
        }

        // VIEW
        function loadOwnerView(id) {
            $("#ownerViewContent").html("Loading...");
            $("#ownerViewContent").load("/Owners/ViewOwner/" + id, function () {
                new bootstrap.Modal(document.getElementById("ownerViewModal")).show();
            });
        }

        // EDIT
        function loadOwnerEdit(id) {
            $("#ownerEditContent").html("Loading...");
            $("#ownerEditContent").load("/Owners/EditOwner/" + id, function () {
                new bootstrap.Modal(document.getElementById("ownerEditModal")).show();
            });
        }

        // DELETE
        function loadOwnerDelete(id) {
            $("#ownerDeleteContent").html("Loading...");
            $("#ownerDeleteContent").load("/Owners/DeleteOwner/" + id, function () {
                new bootstrap.Modal(document.getElementById("ownerDeleteModal")).show();
            });
        }
    </script>
}
