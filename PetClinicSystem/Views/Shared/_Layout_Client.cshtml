@using Microsoft.AspNetCore.Http
@{
    var name = Context.Session.GetString("UserName") ?? "Client";
    var active = ViewBag.ActiveMenu as string ?? "";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Client - St. Paul Clinic</title>

    <!-- CSS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/site.css" />
</head>

<body class="bg-light">

    <!-- SIDEBAR -->
    <div class="typeface sidebar">

        <div class="sidebar-logo mb-4">
            <i class="fa-solid fa-heart text-success me-2"></i>
            St. Paul Clinic
        </div>

        <div class="menu-title">Menu</div>

        <!-- DASHBOARD -->
        <a class="nav-link nav-link-custom @(active == "Dashboard" ? "nav-active" : "")"
           href="/Client/Index">
            <i class="fa-solid fa-gauge me-2"></i> Dashboard
        </a>

        <!-- APPOINTMENTS (client sees only their own – controller handles filter) -->
        <a class="nav-link nav-link-custom @(active == "Appointments" ? "nav-active" : "")"
           href="/Appointments/Index">
            <i class="fa-solid fa-calendar-check me-2"></i> Appointment
        </a>

        <!-- PATIENTS (pets belonging to this client – PetsController handles filter) -->
        <a class="nav-link nav-link-custom @(active == "Pets" ? "nav-active" : "")"
           href="/Pets/Index">
            <i class="fa-solid fa-paw me-2"></i> My Pet
        </a>

        <a class="nav-link nav-link-custom @(ViewBag.ActiveMenu == "Records" ? "nav-active" : "")"
           href="/ClientRecords/Index">
            <i class="fa-solid fa-clipboard-list me-2"></i> Medical Record
        </a>


        <!-- OPTIONAL: if you ever want a billing history page for clients, link it here
        <a class="nav-link nav-link-custom @(active == "Billing" ? "nav-active" : "")"
           href="/BillingPharmacy/Index">
            <i class="fa-solid fa-receipt me-2"></i> Billing
        </a>
        -->
        <!-- MY PROFILE -->
        <a class="nav-link nav-link-custom @(active == "Profile" ? "nav-active" : "")"
           href="/Account/Profile">
            <i class="fa-solid fa-user me-2"></i> My Profile
        </a>

        <!-- LOGOUT BUTTON – opens confirmation modal -->
        <button type="button"
                id="openLogoutModalBtn"
                class="btn btn-outline-danger logout-btn mt-auto">
            <i class="fa-solid fa-right-from-bracket me-2"></i> Logout
        </button>

    </div>

    <!-- TOPBAR -->
    <div class="topbar">
        <h5 class="fw-bold">Client Dashboard</h5>

        <div class="d-flex align-items-center gap-3">
            <span class="fw-semibold">@name</span>
            <div class="user-circle">
                @name?[0]
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content-area">
        @RenderBody()
    </div>

    <!-- REQUIRED JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    @RenderSection("Scripts", required: false)

    <!-- GENERIC TOAST (reuses same pattern as admin/staff) -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
        <div id="appToast"
             class="toast align-items-center text-white bg-success"
             role="alert"
             aria-live="assertive"
             aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body fw-semibold">
                    <!-- message injected by JS -->
                </div>
                <button type="button"
                        class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"
                        aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- LOGOUT CONFIRMATION MODAL -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold">Confirm Logout</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">
                        Are you sure you want to log out of your account?
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button"
                            class="btn btn-danger"
                            id="confirmLogoutBtn">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- HIDDEN FORM THAT ACTUALLY POSTS /Account/Logout -->
    <form id="logoutForm" action="/Account/Logout" method="post"></form>

    <script>
        // ======== GLOBAL TOAST HELPER (same as admin/staff) ========
        function showAppToast(message, type) {
            var el = document.getElementById('appToast');
            if (!el) {
                alert(message || '');
                return;
            }

            var body = el.querySelector('.toast-body');
            body.textContent = message || '';

            el.classList.remove('bg-success', 'bg-danger', 'bg-warning');
            if (type === 'error') {
                el.classList.add('bg-danger');
            } else if (type === 'warning') {
                el.classList.add('bg-warning');
            } else {
                el.classList.add('bg-success');
            }

            var toast = bootstrap.Toast.getOrCreateInstance(el);
            toast.show();
        }

        // convenience aliases (optional)
        window.showSuccessToast = function (msg) {
            showAppToast(msg || 'Operation completed successfully.', 'success');
        };
        window.showErrorToast = function (msg) {
            showAppToast(msg || 'Something went wrong.', 'error');
        };

        // ======== LOGOUT MODAL WIRING ========
        document.addEventListener('DOMContentLoaded', function () {
            var openBtn = document.getElementById('openLogoutModalBtn');
            var confirmBtn = document.getElementById('confirmLogoutBtn');
            var logoutForm = document.getElementById('logoutForm');
            var logoutModalEl = document.getElementById('logoutModal');

            if (openBtn && logoutModalEl) {
                openBtn.addEventListener('click', function () {
                    var modal = new bootstrap.Modal(logoutModalEl);
                    modal.show();
                });
            }

            if (confirmBtn && logoutForm) {
                confirmBtn.addEventListener('click', function () {
                    logoutForm.submit();
                });
            }

            // safety: clean backdrops if any modal closes
            document.addEventListener('hidden.bs.modal', function () {
                document.body.classList.remove('modal-open');
                document.querySelectorAll('.modal-backdrop').forEach(function (e) { e.remove(); });
            });
        });
    </script>

</body>
</html>
