@model PetClinicSystem.Models.Schedule
@using PetClinicSystem.Models
@using PetClinicSystem.Models.ViewModels

@{
    var pets = ViewBag.Pets as List<Pet>;
    var staff = ViewBag.Staff as List<Account>;
    var services = ViewBag.Services as List<Service>;
    int role = Context.Session.GetInt32("UserRole") ?? -1;
    string current = Model.Status?.ToLower() ?? "pending";
}

<div class="modal-header border-0">
    <h5 class="modal-title fw-bold">Edit Appointment</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<form asp-controller="Appointments" asp-action="Edit" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="ScheduleId" />

    <div class="modal-body">
        <div class="row g-3">

            <!-- PET -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Pet</label>
                <select asp-for="PetId" class="form-select" required>
                    @foreach (var p in pets)
                    {
                        <option value="@p.PetId">@p.Name</option>
                    }
                </select>
            </div>

            <!-- STAFF -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Assigned Staff</label>
                <select asp-for="StaffId" id="staffDropdownEdit" class="form-select" required>
                    @foreach (var s in staff)
                    {
                        <option value="@s.AccountId">@s.FullName</option>
                    }
                </select>
            </div>

            <!-- SERVICE -->
            <div class="col-12">
                <label class="form-label fw-semibold">Purpose</label>
                <select asp-for="ServiceId" id="serviceDropdownEdit" class="form-select" required>
                    @foreach (var grp in services.GroupBy(s => s.Category))
                    {
                        <optgroup label="@grp.Key">
                            @foreach (var svc in grp)
                            {
                                <option value="@svc.ServiceId"
                                        data-duration="@svc.DurationMinutes">
                                    @svc.Name
                                </option>
                            }
                        </optgroup>
                    }
                </select>
            </div>

            <!-- DATE -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Date</label>
                <input type="date"
                       asp-for="ScheduleDateOld"
                       id="appointmentDateEdit"
                       class="form-control"
                       min="@DateTime.Today.ToString("yyyy-MM-dd")"
                       required />

                <small id="slotRemainingTextEdit" class="text-primary"></small>
            </div>

            <!-- TIME GRID -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Select Time</label>

                <div id="timeGridEdit" class="d-flex flex-wrap gap-2 border rounded p-2" style="min-height: 60px;">
                    <div class="text-muted small">Select date & service to load times</div>
                </div>

                <!-- Hidden selected slot ID -->
                <input type="hidden" asp-for="SlotId" id="selectedSlotIdEdit" required />
            </div>

            <!-- STATUS -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Status</label>

                @if (role == 0)
                {
                    <input type="hidden" name="Status" value="@Model.Status" />
                    <input type="text" class="form-control" value="@Model.Status" readonly />
                }
                else
                {
                    <select name="Status" class="form-select">

                        <option value="Pending"
                                disabled="@(current != "pending")">
                            Pending
                        </option>

                        <option value="Confirmed"
                                disabled="@(current == "completed" || current == "cancelled")">
                            Confirmed
                        </option>

                        <option value="Urgent"
                                disabled="@(current == "completed" || current == "cancelled")">
                            Urgent
                        </option>

                        <option value="Cancelled"
                                disabled="@(current == "completed" || current == "cancelled")">
                            Cancelled
                        </option>

                        <option value="Completed"
                                disabled="@(current == "completed" || current == "cancelled")">
                            Completed
                        </option>

                    </select>

                }
            </div>
    </div>

    <div class="modal-footer border-0">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Save Changes</button>
    </div>
</form>


@section Scripts {

    <style>
        .time-slot {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            cursor: pointer;
            min-width: 75px;
            text-align: center;
            user-select: none;
            transition: .2s;
            font-weight: 500;
        }

            .time-slot:hover {
                background: #f3f3f3;
            }

            .time-slot.selected {
                background: #0d6efd;
                color: white;
                border-color: #0d6efd;
            }
    </style>


    <script>

        // Load time grid when date or service changes
        $("#appointmentDateEdit, #serviceDropdownEdit").on("change", function () {
            let date = $("#appointmentDateEdit").val();
            let serviceId = $("#serviceDropdownEdit").val();

            if (date && serviceId) {
                loadTimeGridEdit(date, serviceId);
            }
        });

        // LOAD VALID START TIMES (Edit Mode)
        function loadTimeGridEdit(date, serviceId) {

            $("#timeGridEdit").html("<div class='small text-muted'>Loading…</div>");
            $("#selectedSlotIdEdit").val("");

            $.get("/Appointments/GetValidStartTimes",
                { date: date, serviceId: serviceId },
                function (slots) {

                    $("#timeGridEdit").empty();

                    if (slots.length === 0) {
                        $("#timeGridEdit").html("<div class='text-danger small'>No available times</div>");
                        return;
                    }

                    const currentSlot = @Model.SlotId;

                    slots.forEach(s => {
                        let btn = $(`<div class='time-slot'>${s.start}</div>`);

                        btn.data("slotId", s.slotId);

                        // Auto-select existing value
                        if (currentSlot === s.slotId)
                            btn.addClass("selected"),
                            $("#selectedSlotIdEdit").val(s.slotId);

                        btn.on("click", function () {
                            $(".time-slot").removeClass("selected");
                            $(this).addClass("selected");
                            $("#selectedSlotIdEdit").val($(this).data("slotId"));
                        });

                        $("#timeGridEdit").append(btn);
                    });
                }
            );
        }

        // INITIAL LOAD FOR EDITING EXISTING APPOINTMENT
        $(document).ready(function () {
            let date = $("#appointmentDateEdit").val();
            let serviceId = $("#serviceDropdownEdit").val();
            if (date && serviceId) loadTimeGridEdit(date, serviceId);
        });

    </script>
}
